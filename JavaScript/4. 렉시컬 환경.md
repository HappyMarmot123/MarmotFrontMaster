# 렉시컬 환경 (Lexical Environment)

## 📖 개요

**렉시컬 환경(Lexical Environment)**은 자바스크립트 코드가 실행될 때 해당 스코프에 있는 모든 식별자(변수, 함수 선언 등)를 담는 객체입니다. 이는 코드의 렉시컬(정적) 구조에 따라 결정되며, 스코프와 클로저의 동작 원리를 이해하는 핵심 개념입니다.

## 🏗️ 렉시컬 환경의 구성 요소

렉시컬 환경은 두 가지 주요 구성 요소로 이루어져 있습니다.

### 1. 환경 레코드 (Environment Record)

현재 스코프 내의 모든 변수와 함수 선언을 저장하는 실제 저장 공간입니다. 예를 들어, `let`, `const`, `var`로 선언된 변수와 함수 선언문이 여기에 기록됩니다.

#### 환경 레코드의 종류

##### 선언적 환경 레코드 (Declarative Environment Record)

```javascript
function example() {
  let x = 10; // 선언적 환경 레코드에 저장
  const y = 20; // 선언적 환경 레코드에 저장
  var z = 30; // 선언적 환경 레코드에 저장

  function inner() {
    // 함수 선언도 환경 레코드에 저장
    console.log(x + y + z);
  }

  return inner;
}
```

##### 객체 환경 레코드 (Object Environment Record)

```javascript
// with 문이나 전역 스코프에서 사용
with (Math) {
  console.log(PI); // Math.PI에 접근
  console.log(abs(-5)); // Math.abs(-5)에 접근
}
```

### 2. 외부 렉시컬 환경 참조 (Outer Lexical Environment Reference)

자신이 속한 상위(외부) 스코프의 렉시컬 환경을 가리킵니다. 이 참조를 통해 자바스크립트는 변수를 찾기 위해 **스코프 체인(Scope Chain)**을 따라 상위 스코프로 이동할 수 있습니다.

## 🔍 렉시컬 환경의 동작 원리

### 스코프 체인 형성 과정

```javascript
const globalVar = "전역 변수";

function outer() {
  const outerVar = "외부 함수 변수";

  function inner() {
    const innerVar = "내부 함수 변수";

    console.log(globalVar + outerVar + innerVar);
  }

  return inner;
}

const innerFunc = outer();
innerFunc();
```

**렉시컬 환경 체인 구조**:

```
inner() 렉시컬 환경
├── 환경 레코드: { innerVar: '내부 함수 변수' }
└── 외부 렉시컬 환경 참조 → outer() 렉시컬 환경
    ├── 환경 레코드: { outerVar: '외부 함수 변수' }
    └── 외부 렉시컬 환경 참조 → 전역 렉시컬 환경
        └── 환경 레코드: { globalVar: '전역 변수' }
```

### 변수 검색 과정

1. **현재 렉시컬 환경**에서 변수 검색
2. **찾지 못한 경우** 외부 렉시컬 환경 참조를 따라 상위 스코프로 이동
3. **전역 스코프까지** 검색하여 변수를 찾거나 `ReferenceError` 발생

## 💡 실제 동작 예시

### 호이스팅과 환경 레코드

```javascript
console.log(x); // undefined (var는 호이스팅됨)
console.log(y); // ReferenceError (let은 호이스팅되지 않음)

var x = 10;
let y = 20;

function hoistedFunc() {
  console.log("함수 호이스팅");
}
```

**환경 레코드 생성 과정**:

1. **생성 단계**: 모든 변수와 함수 선언을 환경 레코드에 등록
2. **실행 단계**: 실제 값 할당 및 코드 실행

### 클로저와 렉시컬 환경

```javascript
function createCounter() {
  let count = 0; // 이 변수는 createCounter의 렉시컬 환경에 저장

  return function () {
    count++; // 외부 렉시컬 환경 참조를 통해 count에 접근
    return count;
  };
}

const counter = createCounter();
console.log(counter()); // 1
console.log(counter()); // 2
```

**클로저 동작 원리**:

- 내부 함수가 반환될 때, 외부 함수의 렉시컬 환경에 대한 참조를 유지
- 외부 함수의 실행 컨텍스트가 종료되어도 렉시컬 환경은 메모리에 보존
- 내부 함수가 외부 변수에 계속 접근 가능

## ⚠️ 주의사항과 제약사항

### 1. 블록 스코프와 렉시컬 환경

```javascript
{
  let blockVar = "블록 변수";
  console.log(blockVar); // '블록 변수'
}
// console.log(blockVar); // ReferenceError: blockVar is not defined

if (true) {
  const conditionalVar = "조건부 변수";
  console.log(conditionalVar); // '조건부 변수'
}
// console.log(conditionalVar); // ReferenceError
```

### 2. 함수 스코프 vs 블록 스코프

```javascript
function functionScope() {
  if (true) {
    var functionScopedVar = "함수 스코프 변수";
  }
  console.log(functionScopedVar); // '함수 스코프 변수' ✅
}

function blockScope() {
  if (true) {
    let blockScopedVar = "블록 스코프 변수";
  }
  // console.log(blockScopedVar); // ReferenceError ❌
}
```

## 📚 렉시컬 환경의 중요성

**렉시컬 환경은 스코프 체인을 형성하여 변수 접근 규칙을 결정**하고, 함수가 외부 스코프의 변수를 기억할 수 있게 함으로써 **클로저(Closure)**를 가능하게 하는 근본적인 메커니즘입니다.

### 핵심 역할

1. **변수 관리**: 식별자의 생명주기와 접근 범위 제어
2. **스코프 체인**: 상위 스코프로의 체계적인 변수 검색
3. **클로저 지원**: 외부 스코프 변수의 지속적 참조 가능
4. **메모리 효율성**: 사용되지 않는 변수의 적절한 해제

## 🎯 학습 포인트

- 렉시컬 환경은 **코드 작성 시점**에 결정되는 정적 구조
- 환경 레코드는 **실제 변수와 함수**를 저장하는 저장소
- 외부 렉시컬 환경 참조는 **스코프 체인**을 형성하는 연결고리
- 클로저는 **렉시컬 환경의 보존**을 통해 동작
